import { replyMessage, replyWithQuickReply } from '../line/client';
import { getUserLang } from '../database/queries';
import { buildYoloSiteUrl, buildYoloFeatureUrl, addUtmParams } from '../utils/url';
import { config } from '../config';

export async function handleGreeting(
  userId: string,
  replyToken: string,
  lang: string
): Promise<void> {
  const messages: Record<string, any> = {
    ja: {
      greeting: 'ã“ã‚“ã«ã¡ã¯!YOLO JAPANã§ã™âœ¨',
      prompt: 'ä»Šæ—¥ã¯ã©ã®ã‚ˆã†ãªãŠæ‰‹ä¼ã„ãŒã§ãã¾ã™ã‹?\n\nä¾‹ãˆã°...\nğŸ“Œ ä»•äº‹ã‚’æ¢ã—ã¦ã„ã‚‹\nğŸ“Œ ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„\nğŸ“Œ ãŠå•ã„åˆã‚ã›ã—ãŸã„',
      quickReply: [
        { label: 'ğŸ” ä»•äº‹ã‚’æ¢ã™', text: 'ä»•äº‹ã‚’æ¢ã—ã¦ã„ã¾ã™' },
        { label: 'â„¹ï¸ ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹', text: 'ã‚µãƒ¼ãƒ“ã‚¹ã‚’çŸ¥ã‚ŠãŸã„' },
        { label: 'ğŸ“© ãŠå•ã„åˆã‚ã›', text: 'ãŠå•ã„åˆã‚ã›' },
      ],
    },
    en: {
      greeting: 'Hello! This is YOLO JAPANâœ¨',
      prompt: 'How can I help you today?\n\nFor example...\nğŸ“Œ Looking for a job\nğŸ“Œ Learn about our services\nğŸ“Œ Contact us',
      quickReply: [
        { label: 'ğŸ” Find Job', text: "I'm looking for a job" },
        { label: 'â„¹ï¸ Features', text: 'Tell me about services' },
        { label: 'ğŸ“© Contact', text: 'Contact' },
      ],
    },
    ko: {
      greeting: 'ì•ˆë…•í•˜ì„¸ìš”! YOLO JAPANì…ë‹ˆë‹¤âœ¨',
      prompt: 'ì˜¤ëŠ˜ì€ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?\n\nì˜ˆë¥¼ ë“¤ì–´...\nğŸ“Œ ì¼ìë¦¬ ì°¾ê¸°\nğŸ“Œ ì„œë¹„ìŠ¤ ì†Œê°œ\nğŸ“Œ ë¬¸ì˜í•˜ê¸°',
      quickReply: [
        { label: 'ğŸ” ì¼ìë¦¬ ì°¾ê¸°', text: 'ì¼ìë¦¬ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤' },
        { label: 'â„¹ï¸ ì„œë¹„ìŠ¤ ì†Œê°œ', text: 'ì„œë¹„ìŠ¤ë¥¼ ì•Œê³  ì‹¶ì–´ìš”' },
        { label: 'ğŸ“© ë¬¸ì˜', text: 'ë¬¸ì˜í•˜ê¸°' },
      ],
    },
    zh: {
      greeting: 'ä½ å¥½!è¿™é‡Œæ˜¯YOLO JAPANâœ¨',
      prompt: 'ä»Šå¤©éœ€è¦ä»€ä¹ˆå¸®åŠ©?\n\nä¾‹å¦‚...\nğŸ“Œ æ‰¾å·¥ä½œ\nğŸ“Œ æœåŠ¡ä»‹ç»\nğŸ“Œ è”ç³»æˆ‘ä»¬',
      quickReply: [
        { label: 'ğŸ” æ‰¾å·¥ä½œ', text: 'æˆ‘åœ¨æ‰¾å·¥ä½œ' },
        { label: 'â„¹ï¸ æœåŠ¡ä»‹ç»', text: 'æˆ‘æƒ³äº†è§£æœåŠ¡' },
        { label: 'ğŸ“© è”ç³»', text: 'è”ç³»æˆ‘ä»¬' },
      ],
    },
    vi: {
      greeting: 'Xin chÃ o! ÄÃ¢y lÃ  YOLO JAPANâœ¨',
      prompt: 'HÃ´m nay tÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n?\n\nVÃ­ dá»¥...\nğŸ“Œ TÃ¬m viá»‡c lÃ m\nğŸ“Œ Giá»›i thiá»‡u dá»‹ch vá»¥\nğŸ“Œ LiÃªn há»‡',
      quickReply: [
        { label: 'ğŸ” TÃ¬m viá»‡c', text: 'TÃ´i Ä‘ang tÃ¬m viá»‡c' },
        { label: 'â„¹ï¸ Giá»›i thiá»‡u', text: 'TÃ´i muá»‘n biáº¿t vá» dá»‹ch vá»¥' },
        { label: 'ğŸ“© LiÃªn há»‡', text: 'LiÃªn há»‡' },
      ],
    },
  };

  const msg = messages[lang] || messages.ja;

  await replyMessage(replyToken, [
    {
      type: 'text',
      text: msg.greeting,
    },
    {
      type: 'text',
      text: msg.prompt,
      quickReply: {
        items: msg.quickReply.map((item: any) => ({
          type: 'action',
          action: {
            type: 'message',
            label: item.label,
            text: item.text,
          },
        })),
      },
    },
  ]);
}

export async function handleContact(
  event: any,
  lang: string
): Promise<void> {
  const userId = event.source.userId;
  const replyToken = event.replyToken;
): Promise<void> {
  const lang = await getUserLang(userId);

  const baseUrls: Record<string, string> = {
    ja: 'https://www.yolo-japan.com/ja/inquiry/input',
    en: 'https://www.yolo-japan.com/en/inquiry/input',
    ko: 'https://www.yolo-japan.com/ko/inquiry/input',
    zh: 'https://www.yolo-japan.com/zh-TW/inquiry/input',
    vi: 'https://www.yolo-japan.com/vi/inquiry/input',
  };

  const url = addUtmParams(baseUrls[lang] || baseUrls.ja, 'contact');

  const messages: Record<string, string> = {
    ja: `ãŠå•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰ã‹ã‚‰â†“\n${url}`,
    en: `Contact us hereâ†“\n${url}`,
    ko: `ë¬¸ì˜ëŠ” ì—¬ê¸°ì—ì„œâ†“\n${url}`,
    zh: `è«‹åœ¨æ­¤è™•è¯ç¹«æˆ‘å€‘â†“\n${url}`,
    vi: `LiÃªn há»‡ vá»›i chÃºng tÃ´i táº¡i Ä‘Ã¢yâ†“\n${url}`,
  };

  await replyMessage(replyToken, {
    type: 'text',
    text: messages[lang] || messages.ja,
  });
}

export async function handleFindJob(
  userId: string,
  replyToken: string
): Promise<void> {
  const lang = await getUserLang(userId);

  const messages: Record<string, string> = {
    ja: 'ã©ã¡ã‚‰ã®æ–¹æ³•ã§æ¢ã—ã¾ã™ã‹ï¼Ÿ',
    en: 'How would you like to search?',
    ko: 'ì–´ë–»ê²Œ ì°¾ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?',
    zh: 'æ‚¨æƒ³å¦‚ä½•æœç´¢ï¼Ÿ',
    vi: 'Báº¡n muá»‘n tÃ¬m kiáº¿m nhÆ° tháº¿ nÃ o?',
  };

  const aiLabel: Record<string, string> = {
    ja: 'AIã«ä¸¸æŠ•ã’',
    en: 'Ask AI',
    ko: 'AIì—ê²Œ ë¬¼ì–´ë³´ê¸°',
    zh: 'è¯¢é—®AI',
    vi: 'Há»i AI',
  };

  const siteLabel: Record<string, string> = {
    ja: 'ã‚µã‚¤ãƒˆã§æ¢ã™',
    en: 'Search on Site',
    ko: 'ì‚¬ì´íŠ¸ì—ì„œ ê²€ìƒ‰',
    zh: 'åœ¨ç½‘ç«™ä¸Šæœç´¢',
    vi: 'TÃ¬m trÃªn trang web',
  };

  await replyWithQuickReply(replyToken, messages[lang] || messages.ja, [
    {
      type: 'action',
      action: {
        type: 'message',
        label: aiLabel[lang] || aiLabel.ja,
        text: 'AI_MODE',
      },
    },
    {
      type: 'action',
      action: {
        type: 'message',
        label: siteLabel[lang] || siteLabel.ja,
        text: 'SITE_MODE',
      },
    },
  ]);
}

export async function handleSiteMode(
  userId: string,
  replyToken: string
): Promise<void> {
  const lang = await getUserLang(userId);
  const siteUrl = buildYoloSiteUrl(lang);

  const messages: Record<string, string> = {
    ja: `ã“ã¡ã‚‰ã‹ã‚‰ãŠä»•äº‹ã‚’æ¢ã›ã¾ã™ï¼š\n${siteUrl}`,
    en: `You can search for jobs here:\n${siteUrl}`,
    ko: `ì—¬ê¸°ì—ì„œ ì¼ìë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n${siteUrl}`,
    zh: `æ‚¨å¯ä»¥åœ¨è¿™é‡Œæœç´¢å·¥ä½œï¼š\n${siteUrl}`,
    vi: `Báº¡n cÃ³ thá»ƒ tÃ¬m cÃ´ng viá»‡c táº¡i Ä‘Ã¢y:\n${siteUrl}`,
  };

  await replyMessage(replyToken, {
    type: 'text',
    text: messages[lang] || messages.ja,
  });
}

export async function handleViewFeatures(
  userId: string,
  replyToken: string
): Promise<void> {
  const lang = await getUserLang(userId);
  const featureUrl = buildYoloFeatureUrl(lang);

  const messages: Record<string, string> = {
    ja: `ãŠã™ã™ã‚ã®æ±‚äººç‰¹é›†ã¯ã“ã¡ã‚‰ï¼š\n${featureUrl}`,
    en: `Featured jobs here:\n${featureUrl}`,
    ko: `ì¶”ì²œ íŠ¹ì§‘:\n${featureUrl}`,
    zh: `æ¨èç‰¹è¾‘ï¼š\n${featureUrl}`,
    vi: `Äáº·c sáº£n Ä‘á» xuáº¥t:\n${featureUrl}`,
  };

  await replyMessage(replyToken, {
    type: 'text',
    text: messages[lang] || messages.ja,
  });
}

export async function handleNoThanks(
  userId: string,
  replyToken: string
): Promise<void> {
  const lang = await getUserLang(userId);

  const messages: Record<string, string> = {
    ja: 'ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸ!ğŸ˜Š\n\nä½•ã‹ãŠå›°ã‚Šã®ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ã€‚',
    en: 'Understood!ğŸ˜Š\n\nIf you need anything, feel free to ask anytime.',
    ko: 'ì•Œê² ìŠµë‹ˆë‹¤!ğŸ˜Š\n\në¬´ì—‡ì´ë“  í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“ ì§€ ë§ì”€í•´ì£¼ì„¸ìš”.',
    zh: 'æ˜ç™½äº†!ğŸ˜Š\n\nå¦‚æœæ‚¨æœ‰ä»»ä½•éœ€è¦ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚',
    vi: 'Hiá»ƒu rá»“i!ğŸ˜Š\n\nNáº¿u báº¡n cáº§n gÃ¬, hÃ£y há»i báº¥t cá»© lÃºc nÃ o.',
  };

  await replyMessage(replyToken, {
    type: 'text',
    text: messages[lang] || messages.ja,
  });
}

export async function handleYoloDiscover(
  event: any,
  lang: string
): Promise<void> {
  const userId = event.source.userId;
  const replyToken = event.replyToken;
  let displayName = '';
  try {
    const profileResponse = await fetch(`https://api.line.me/v2/bot/profile/${userId}`, {
      headers: {
        'Authorization': `Bearer ${config.line.channelAccessToken}`,
      },
    });
    const profile = await profileResponse.json();
    displayName = profile.displayName || '';
  } catch (error) {
    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
  }

  const greeting = displayName ? `${displayName}ã•ã‚“ã®` : 'ã‚ãªãŸã®';

  // æ—¥æœ¬èªã ã‘ã€Œã•ã‚“ã€ã‚’ä»˜ã‘ã‚‹
  const greetingJa = displayName ? `${displayName}ã•ã‚“ã®` : 'ã‚ãªãŸã®';
  const greetingEn = displayName ? `${displayName}'s` : 'Your';
  const greetingKo = displayName ? `${displayName}ë‹˜ì˜` : 'ë‹¹ì‹ ì˜';
  const greetingZh = displayName ? `${displayName}çš„` : 'æ‚¨çš„';
  const greetingVi = displayName ? `${displayName} Cá»§a` : '';

  const messages: Record<string, string> = {
    ja: `ã€${greetingJa}æ—¥æœ¬ç”Ÿæ´»ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€‘

YOLO :DISCOVERã¯ã€ã‚°ãƒ«ãƒ¡ãƒ»è¦³å…‰ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ãªã©ã€æ—¥æœ¬ã®é­…åŠ›ã‚’ç„¡æ–™ã§ä½“é¨“ã—ã€ã‚ãªãŸã®SNSã§æ—¥æœ¬ã®é­…åŠ›ã‚’ç™ºä¿¡ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

æ„Ÿã˜ãŸã“ã¨ã‚’ã‚·ã‚§ã‚¢ã™ã‚‹ã ã‘ã€‚
SNSã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã¯å•ã„ã¾ã›ã‚“ã€‚

âœ¨ ã“ã‚“ãªãŠåº—ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½“é¨“ã§ãã¾ã™
ãƒ»1äººå‰3ä¸‡å††ã®ã™ãç„¼ãåº—
ãƒ»è¡Œåˆ—ãŒã§ãã‚‹ãŠå¯¿å¸å±‹ã•ã‚“
ãƒ»ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«å®¿æ³Š
ãªã©ãªã©

YOLO :DISCOVERãªã‚‰ã€ã“ã‚Œã‚‰ãŒç„¡æ–™ã§ä½“é¨“ã§ãã¾ã™ï¼

ğŸ’° ç™»éŒ²ãƒ»å‚åŠ ã™ã¹ã¦ç„¡æ–™
â€»åº—èˆ—ã¸ã®äº¤é€šè²»ã¯å®Ÿè²»

ğŸ‘‡ ä»Šã™ããƒã‚§ãƒƒã‚¯
https://wom.yolo-japan.com/ja/projects/?utm_source=line&utm_medium=chatbot&utm_campaign=yolo_discover`,
    en: `ã€Upgrade ${greetingEn} Life in Japanã€‘
YOLO :DISCOVER

YOLO :DISCOVER is a service where you can experience Japanese culture for freeâ€”from gourmet dining to travel and lifestyleâ€”and share Japan's appeal on your SNS.

Just share what you feel.
No follower count required.

âœ¨ Experience services at places like:
ãƒ»Premium sukiyaki restaurant (Â¥30,000 per person)
ãƒ»Popular sushi restaurant with long queues
ãƒ»Resort hotel stays
And more!

With YOLO :DISCOVER, you can experience all of these for FREE!

ğŸ’° Registration & participation FREE
â€»Transportation costs at your own expense

ğŸ‘‡ Check now
https://wom.yolo-japan.com/en/projects/?utm_source=line&utm_medium=chatbot&utm_campaign=yolo_discover`,
    ko: `ã€${greetingKo} ì¼ë³¸ ìƒí™œì„ ì—…ê·¸ë ˆì´ë“œã€‘
YOLO :DISCOVER

YOLO :DISCOVERëŠ” ê·¸ë£¨ë©”Â·ê´€ê´‘Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ ë“± ì¼ë³¸ì˜ ë§¤ë ¥ì„ ë¬´ë£Œë¡œ ì²´í—˜í•˜ê³ , SNSì—ì„œ ì¼ë³¸ì˜ ë§¤ë ¥ì„ ì „ë‹¬í•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

ëŠë‚€ ê²ƒì„ ê³µìœ í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.
SNS íŒ”ë¡œì›Œ ìˆ˜ëŠ” ìƒê´€ì—†ìŠµë‹ˆë‹¤.

âœ¨ ì´ëŸ° ê³³ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì²´í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
ãƒ»1ì¸ 3ë§Œì—” ìŠ¤í‚¤ì•¼í‚¤ ì „ë¬¸ì 
ãƒ»ì¤„ ì„œëŠ” ì´ˆë°¥ì§‘
ãƒ»ë¦¬ì¡°íŠ¸ í˜¸í…” ìˆ™ë°•
ë“±ë“±

YOLO :DISCOVERë¡œ ì´ ëª¨ë“  ê²ƒì„ ë¬´ë£Œë¡œ ì²´í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ğŸ’° ë“±ë¡Â·ì°¸ê°€ ëª¨ë‘ ë¬´ë£Œ
â€»êµí†µë¹„ëŠ” ë³¸ì¸ ë¶€ë‹´

ğŸ‘‡ ì§€ê¸ˆ í™•ì¸
https://wom.yolo-japan.com/ko/projects/?utm_source=line&utm_medium=chatbot&utm_campaign=yolo_discover`,
    zh: `ã€å‡çº§${greetingZh}æ—¥æœ¬ç”Ÿæ´»ã€‘
YOLO :DISCOVER

YOLO :DISCOVERæ˜¯ä¸€é¡¹å¯ä»¥å…è´¹ä½“éªŒæ—¥æœ¬ç¾é£Ÿã€æ—…æ¸¸ã€ç”Ÿæ´»æ–¹å¼ç­‰é­…åŠ›ï¼Œå¹¶åœ¨æ‚¨çš„SNSä¸Šä¼ æ’­æ—¥æœ¬é­…åŠ›çš„æœåŠ¡ã€‚

åªéœ€åˆ†äº«æ‚¨çš„æ„Ÿå—ã€‚
ä¸é™SNSç²‰ä¸æ•°ã€‚

âœ¨ å¯ä»¥åœ¨è¿™äº›åœ°æ–¹ä½“éªŒæœåŠ¡
ãƒ»äººå‡3ä¸‡æ—¥å…ƒçš„å¯¿å–œçƒ§åº—
ãƒ»æ’é˜Ÿçš„å¯¿å¸åº—
ãƒ»åº¦å‡é…’åº—ä½å®¿
ç­‰ç­‰

é€šè¿‡YOLO :DISCOVERï¼Œæ‚¨å¯ä»¥å…è´¹ä½“éªŒè¿™äº›ï¼

ğŸ’° æ³¨å†ŒÂ·å‚åŠ å…¨éƒ¨å…è´¹
â€»äº¤é€šè´¹è‡ªç†

ğŸ‘‡ ç«‹å³æŸ¥çœ‹
https://wom.yolo-japan.com/zh-TW/projects/?utm_source=line&utm_medium=chatbot&utm_campaign=yolo_discover`,
    vi: `ã€NÃ¢ng Cáº¥p Cuá»™c Sá»‘ng Nháº­t Báº£n${greetingVi ? ' ' + greetingVi : ''}ã€‘
YOLO :DISCOVER

YOLO :DISCOVER lÃ  dá»‹ch vá»¥ tráº£i nghiá»‡m miá»…n phÃ­ sá»©c háº¥p dáº«n cá»§a Nháº­t Báº£n tá»« áº©m thá»±c, du lá»‹ch Ä‘áº¿n phong cÃ¡ch sá»‘ng, vÃ  chia sáº» sá»©c háº¥p dáº«n cá»§a Nháº­t Báº£n trÃªn SNS cá»§a báº¡n.

Chá»‰ cáº§n chia sáº» nhá»¯ng gÃ¬ báº¡n cáº£m nháº­n.
KhÃ´ng yÃªu cáº§u sá»‘ lÆ°á»£ng followers.

âœ¨ Tráº£i nghiá»‡m dá»‹ch vá»¥ táº¡i nhá»¯ng nÆ¡i nhÆ°:
ãƒ»NhÃ  hÃ ng sukiyaki cao cáº¥p (Â¥30,000/ngÆ°á»i)
ãƒ»NhÃ  hÃ ng sushi xáº¿p hÃ ng dÃ i
ãƒ»Nghá»‰ dÆ°á»¡ng táº¡i khÃ¡ch sáº¡n resort
VÃ  nhiá»u hÆ¡n ná»¯a!

Vá»›i YOLO :DISCOVER, báº¡n cÃ³ thá»ƒ tráº£i nghiá»‡m táº¥t cáº£ MIá»„N PHÃ!

ğŸ’° ÄÄƒng kÃ½ & tham gia MIá»„N PHÃ
â€»Chi phÃ­ di chuyá»ƒn tá»± tÃºc

ğŸ‘‡ Kiá»ƒm tra ngay
https://wom.yolo-japan.com/vi/projects/?utm_source=line&utm_medium=chatbot&utm_campaign=yolo_discover`,
  };

  await replyMessage(replyToken, {
    type: 'text',
    text: messages[lang] || messages.ja,
  });
}
// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
export async function handleButtonAction(
  event: any,
  state: any,
  action: string,
  lang: string
): Promise<void> {
  const userId = event.source.userId;
  
  switch (action) {
    case 'SITE_MODE':
      await handleSiteMode(event, lang);
      break;
    case 'VIEW_FEATURES':
      await handleViewFeatures(event, lang);
      break;
    case 'CONTACT':
      await handleContact(event, lang);
      break;
    case 'YOLO_DISCOVER':
      await handleYoloDiscover(event, lang);
      break;
    default:
      console.log(`Unknown button action: ${action}`);
  }
}

// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
